# 開発ガイド

## プロジェクト概要

このプロジェクトは、M5Stack TAB5上でネオンテトラが泳ぐシミュレーションを実装しています。

## アーキテクチャ

### メインループ

```
setup()
  ├─ M5.begin()
  ├─ initDisplay()
  ├─ SPIFFS.begin()
  ├─ loadFishImages()
  └─ initFishes()

loop()
  ├─ drawBackground()
  ├─ updateFishes(delta_ms)
  ├─ drawFishes()
  └─ delay(33ms) // 約30FPS
```

### 魚の更新ロジック

1. **位置の更新**: 速度に基づいて位置を更新
2. **画面端での反射**: 画面の端に達したら速度を反転
3. **ランダムな行動**: 一定時間ごとにランダムに方向を変更
4. **速度の制限**: 最大速度を超えないようにクリップ

## 画像フォーマット

### ネオンテトラの画像

- **フォーマット**: PNG（透明背景）
- **解像度**: 358×200 px
- **ファイルサイズ**: 約51-53 KB
- **保存場所**: `/data/images/`

### 画像の最適化

元の画像（2752×1536 px）から最適化版（358×200 px）に縮小することで、メモリ使用量を削減しています。

```
元のサイズ: 2752 × 1536 = 4,227,072 ピクセル
最適化後: 358 × 200 = 71,600 ピクセル
削減率: 約98.3%
```

## メモリ管理

### PSRAM（32MB）の使用

- **魚の画像**: 約51-53 KB × 2 = 約100 KB
- **その他のデータ**: 数 KB

M5Stack TAB5の32MBのPSRAMは十分な容量があるため、複数の魚や追加の機能を実装できます。

## 今後の実装予定

### Phase 2: インタラクティブ機能

- タッチ入力の検出
- 給餌機能
- 魚の状態表示（吹き出し）

### Phase 3: ゲーム機能

- 水質管理システム
- 魚の健康度管理
- スコアシステム

### Phase 4: データ永続化

- フラッシュメモリへのセーブ機能
- SDカードへのエキスポート・インポート機能

## デバッグ方法

### シリアルモニタ

```bash
platformio device monitor --baud 115200
```

### ログ出力

コード内で `M5_LOGI()`, `M5_LOGW()`, `M5_LOGE()` を使用してログを出力できます。

```cpp
M5_LOGI("Setup complete");
M5_LOGE("Failed to load fish image");
```

## パフォーマンス最適化

### フレームレート

現在、約30FPSで動作するように設定されています。

```cpp
delay(33); // 1000ms / 30fps ≈ 33ms
```

### 描画最適化

- 背景のグラデーション描画を最適化
- 魚の描画を効率化
- 不要な再描画を削減

## トラブルシューティング

### メモリ不足エラー

1. 魚の数を減らす
2. 画像サイズをさらに縮小
3. 不要なデータ構造を削除

### フレームレート低下

1. 描画処理を最適化
2. 物理計算を簡略化
3. 魚の数を減らす

### 画像が表示されない

1. SPIFFS にファイルが正しくアップロードされているか確認
2. ファイルパスが正しいか確認
3. ファイルの形式が PNG であるか確認

## 参考資料

- [M5Stack 公式ドキュメント](https://docs.m5stack.com/)
- [M5Unified GitHub](https://github.com/M5Stack/M5Unified)
- [PlatformIO ドキュメント](https://docs.platformio.org/)
